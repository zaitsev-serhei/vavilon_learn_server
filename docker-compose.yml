version: "3.8"
services:
  # Simple Kafka single-node in KRaft mode
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@localhost:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    volumes:
      - kafka-data:/var/lib/kafka/data
    command: >
      bash -c "
        if [ ! -f /var/lib/kafka/data/meta.properties ]; then
          CLUSTER_ID=$(/opt/kafka/bin/kafka-storage.sh random-uuid) &&
          /opt/kafka/bin/kafka-storage.sh format -t ${CLUSTER_ID} -c /opt/kafka/config/kraft/server.properties;
        fi &&
        /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties
      "

  postgres:
    image: postgres:17
    container_name: vavilon-postgres
    environment:
      POSTGRES_DB: vavilon_learn_dev
      POSTGRES_USER: user_dev
      POSTGRES_PASSWORD: dev_pass
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_dev -d vavilon_learn_dev"]
      interval: 5s
      timeout: 5s
      retries: 10

  # CONFIG SERVICE (no DB/Kafka)
  config-service:
    build:
      context: .
      dockerfile: Dockerfile.template
      args:
        MODULE_PATH: config_service
        MODULE_PORT: 8888
    container_name: config-service
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8888
    ports:
      - "8888:8888"

  # API GATEWAY (no DB/Kafka)
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.template
      args:
        MODULE_PATH: api_gateway_service
        MODULE_PORT: 8080
    container_name: api-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8080
    ports:
      - "8080:8080"
    depends_on:
      - config-service
      - discovery-service

  # DISCOVERY SERVICE (no DB/Kafka)
  discovery-service:
    build:
      context: .
      dockerfile: Dockerfile.template
      args:
        MODULE_PATH: discovery_service
        MODULE_PORT: 8761
    container_name: discovery-service
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8761
    ports:
      - "8761:8761"
    depends_on:
      - config-service

  # MAIN SERVICE (needs Kafka + Postgres + Google secrets)
  main-service:
    build:
      context: .
      dockerfile: Dockerfile.template
      args:
        MODULE_PATH: main_service_old
        MODULE_PORT: 8082
    container_name: main-service
    env_file:
      - ./main_service_old/src/main/resources.env
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8082
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/vavilon_learn_dev
      - SPRING_DATASOURCE_USERNAME=user_dev
      - SPRING_DATASOURCE_PASSWORD=dev_pass
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET are loaded from .env via env_file
    ports:
      - "8082:8082"
    depends_on:
      - kafka
      - postgres

  # NOTIFICATION SERVICE (needs Kafka + MongoDB Atlas)
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.template
      args:
        MODULE_PATH: notification_service
        MODULE_PORT: 8075
    container_name: notification-service
    env_file:
      - ./notification_service/src/main/resources.env
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8075
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # MONGODB_URI is loaded from .env
    ports:
      - "8075:8075"
    depends_on:
      - kafka

volumes:
  pgdata:
  kafka-data:
